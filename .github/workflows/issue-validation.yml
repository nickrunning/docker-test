name: Issue Validation

on:
  issues:
    types: [opened, edited]

jobs:
  validate-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check Issue Title Length
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.trim();
            const minTitleLength = 10;
            const maxTitleLength = 120;
            
            console.log(`Issue title: "${title}"`);
            console.log(`Title length: ${title.length}`);
            
            // å»é™¤æ¨¡æ¿å‰ç¼€è¿›è¡Œé•¿åº¦æ£€æŸ¥
            const cleanTitle = title.replace(/^\[(Bug|Feature|General)\]:\s*/i, '').trim();
            
            if (cleanTitle.length < minTitleLength) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ **æ ‡é¢˜è¿‡çŸ­**\n\næ‚¨çš„issueæ ‡é¢˜å†…å®¹å¤ªçŸ­äº†ï¼ˆå½“å‰æœ‰æ•ˆå†…å®¹${cleanTitle.length}ä¸ªå­—ç¬¦ï¼Œæœ€å°‘éœ€è¦${minTitleLength}ä¸ªå­—ç¬¦ï¼‰ã€‚è¯·æä¾›ä¸€ä¸ªæ›´å…·æè¿°æ€§çš„æ ‡é¢˜ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½åœ°ç†è§£é—®é¢˜ã€‚\n\n**ç¤ºä¾‹ï¼š**\n- âœ… "[Bug]: å¾®ä¿¡æ— æ³•å¯åŠ¨æ˜¾ç¤ºé»‘å±"\n- âŒ "[Bug]: æœ‰é—®é¢˜"\n\nè¯·ç¼–è¾‘issueæ ‡é¢˜ï¼Œæä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-more-info']
              });
            } else if (title.length > maxTitleLength) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ **æ ‡é¢˜è¿‡é•¿**\n\næ‚¨çš„issueæ ‡é¢˜å¤ªé•¿äº†ï¼ˆå½“å‰${title.length}ä¸ªå­—ç¬¦ï¼Œå»ºè®®ä¸è¶…è¿‡${maxTitleLength}ä¸ªå­—ç¬¦ï¼‰ã€‚è¯·ç®€åŒ–æ ‡é¢˜ï¼Œå°†è¯¦ç»†ä¿¡æ¯ç§»è‡³æè¿°éƒ¨åˆ†ã€‚`
              });
            }

      - name: Check Issue Body Length
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body ? issue.body.trim() : '';
            const minBodyLength = 50;
            
            console.log(`Issue body length: ${body.length}`);
            
            if (body.length < minBodyLength) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ **æè¿°è¿‡çŸ­**\n\næ‚¨çš„issueæè¿°å¤ªç®€çŸ­äº†ï¼ˆå½“å‰${body.length}ä¸ªå­—ç¬¦ï¼Œæœ€å°‘éœ€è¦${minBodyLength}ä¸ªå­—ç¬¦ï¼‰ã€‚ä¸ºäº†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å’Œè§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š\n\n- è¯¦ç»†çš„é—®é¢˜æè¿°\n- é‡ç°æ­¥éª¤\n- é¢„æœŸè¡Œä¸º\n- å®é™…è¡Œä¸º\n- ç¯å¢ƒä¿¡æ¯ï¼ˆæ“ä½œç³»ç»Ÿã€æµè§ˆå™¨ã€Dockerç‰ˆæœ¬ç­‰ï¼‰\n- ç›¸å…³æ—¥å¿—æˆ–é”™è¯¯ä¿¡æ¯\n\nè¯·ç¼–è¾‘issueæè¿°ï¼Œæ·»åŠ æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-more-info']
              });
            }

      - name: Check for Template Usage
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨¡æ¿ä¸­çš„å ä½ç¬¦æ–‡æœ¬ï¼ˆè¡¨æ˜ç”¨æˆ·æ²¡æœ‰å¡«å†™å®Œæ•´ï¼‰
            const templatePlaceholders = [
              'ä¾‹å¦‚ï¼š',
              'placeholder',
              '...',
              'è¯·æè¿°',
              'è¯·å¡«å†™',
              'è¯·æä¾›'
            ];
            
            const hasPlaceholders = templatePlaceholders.some(placeholder => 
              body.toLowerCase().includes(placeholder)
            );
            
            if (hasPlaceholders) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ **æ¨¡æ¿æœªå®Œæ•´å¡«å†™**\n\nçœ‹èµ·æ¥æ‚¨å¯èƒ½æ²¡æœ‰å®Œå…¨å¡«å†™issueæ¨¡æ¿ã€‚è¯·ç¡®ä¿ï¼š\n\n- åˆ é™¤æ‰€æœ‰å ä½ç¬¦æ–‡æœ¬å’Œç¤ºä¾‹\n- å¡«å†™æ‰€æœ‰å¿…éœ€çš„å­—æ®µ\n- æä¾›çœŸå®çš„ã€å…·ä½“çš„ä¿¡æ¯\n\nè¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¿«åœ°ç†è§£å’Œè§£å†³æ‚¨çš„é—®é¢˜ã€‚`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-more-info']
              });
            }

      - name: Auto-assign Labels Based on Content
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = title + ' ' + body;
            
            const labelRules = [
              {
                keywords: ['docker', 'dockerfile', 'compose', 'å®¹å™¨'],
                label: 'docker'
              },
              {
                keywords: ['å¾®ä¿¡', 'wechat', 'ç™»å½•', 'login'],
                label: 'wechat'
              },
              {
                keywords: ['ç½‘ç»œ', 'network', 'proxy', 'ä»£ç†', 'ssl', 'https'],
                label: 'network'
              },
              {
                keywords: ['æ€§èƒ½', 'performance', 'slow', 'æ…¢', 'memory', 'å†…å­˜'],
                label: 'performance'
              },
              {
                keywords: ['éŸ³é¢‘', 'audio', 'å£°éŸ³', 'sound'],
                label: 'audio'
              },
              {
                keywords: ['è§†é¢‘', 'video', 'æ˜¾ç¤º', 'display'],
                label: 'video'
              },
              {
                keywords: ['æ–‡æ¡£', 'documentation', 'readme', 'doc'],
                label: 'documentation'
              }
            ];
            
            const labelsToAdd = [];
            for (const rule of labelRules) {
              if (rule.keywords.some(keyword => content.includes(keyword))) {
                labelsToAdd.push(rule.label);
              }
            }
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }

      - name: Welcome First Time Contributors
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡æäº¤issueçš„ç”¨æˆ·
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: issue.user.login,
              state: 'all'
            });
            
            if (issues.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ‰ **æ¬¢è¿é¦–æ¬¡è´¡çŒ®ï¼**\n\næ„Ÿè°¢æ‚¨æäº¤ç¬¬ä¸€ä¸ªissueï¼æˆ‘ä»¬å¾ˆé«˜å…´æ‚¨é€‰æ‹©ä½¿ç”¨å¹¶æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚\n\n**æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼š**\n- ç»´æŠ¤è€…å°†å®¡æŸ¥æ‚¨çš„issue\n- å¦‚æœéœ€è¦æ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šåœ¨è¯„è®ºä¸­è¯¢é—®\n- æˆ‘ä»¬ä¼šå°½å¿«å›å¤å¹¶æä¾›å¸®åŠ©\n\n**æœ‰ç”¨çš„èµ„æºï¼š**\n- [é¡¹ç›®æ–‡æ¡£](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/README.md)\n- [è®¨è®ºåŒº](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions)\n\nå†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ™`
              });
            }