name: Discussion Management

on:
  discussion:
    types: [created, edited]
  discussion_comment:
    types: [created]

jobs:
  manage-discussions:
    runs-on: ubuntu-latest
    steps:
      - name: Welcome First-time Discussion Participants
        uses: actions/github-script@v6
        if: github.event.action == 'created' && github.event.discussion
        with:
          script: |
            const discussion = context.payload.discussion;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡å‚ä¸è®¨è®ºçš„ç”¨æˆ·
            const { data: discussions } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} author:${discussion.user.login} type:discussion`,
              sort: 'created',
              order: 'asc'
            });
            
            if (discussions.total_count === 1) {
              const welcomeMessage = `ğŸ‰ **æ¬¢è¿é¦–æ¬¡å‚ä¸è®¨è®ºï¼**\n\næ„Ÿè°¢ @${discussion.user.login} åœ¨ç¤¾åŒºä¸­å¼€å¯è®¨è®ºï¼\n\n**è®¨è®ºåŒºæŒ‡å—ï¼š**\n- ğŸ’¬ è¿™é‡Œæ˜¯å¼€æ”¾çš„äº¤æµå¹³å°ï¼Œé€‚åˆé—®ç­”ã€åˆ†äº«å’Œè®¨è®º\n- ğŸ” å¯ä»¥æœç´¢ç°æœ‰è®¨è®ºé¿å…é‡å¤\n- ğŸ·ï¸ ä½¿ç”¨åˆé€‚çš„åˆ†ç±»å’Œæ ‡ç­¾\n- ğŸ¤ ä¿æŒå‹å–„å’Œå»ºè®¾æ€§çš„äº¤æµ\n\n**æœ‰ç”¨èµ„æºï¼š**\n- ğŸ“š [è®¨è®ºåŒºæŒ‡å—](.github/DISCUSSION_TEMPLATE/GUIDE.md)\n- ğŸ› ç¡®å®šçš„Bugè¯·æäº¤ [Issues](../../issues)\n- ğŸ“– é¡¹ç›®æ–‡æ¡£è¯·æŸ¥çœ‹ [README](../../README.md)\n\næˆ‘ä»¬æœŸå¾…æ‚¨çš„ç§¯æå‚ä¸ï¼å¦‚æœæ‚¨çš„é—®é¢˜å¾—åˆ°è§£å†³ï¼Œè¯·è€ƒè™‘æ ‡è®°æœ€ä½³ç­”æ¡ˆã€‚`;
              
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: welcomeMessage
              });
            }

      - name: Check Discussion Quality
        uses: actions/github-script@v6
        if: github.event.action == 'created' && github.event.discussion
        with:
          script: |
            const discussion = context.payload.discussion;
            const title = discussion.title.trim();
            const body = discussion.body ? discussion.body.trim() : '';
            
            console.log(`Discussion title: "${title}" (${title.length} chars)`);
            console.log(`Discussion body: ${body.length} chars`);
            
            const issues = [];
            
            // æ£€æŸ¥æ ‡é¢˜é•¿åº¦
            if (title.length < 10) {
              issues.push('æ ‡é¢˜è¿‡çŸ­ï¼ˆè‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦ï¼‰');
            } else if (title.length > 200) {
              issues.push('æ ‡é¢˜è¿‡é•¿ï¼ˆå»ºè®®ä¸è¶…è¿‡200ä¸ªå­—ç¬¦ï¼‰');
            }
            
            // æ£€æŸ¥å†…å®¹é•¿åº¦
            if (body.length < 30) {
              issues.push('å†…å®¹è¿‡çŸ­ï¼ˆè‡³å°‘éœ€è¦30ä¸ªå­—ç¬¦ä»¥æä¾›è¶³å¤Ÿä¿¡æ¯ï¼‰');
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§çš„æ— æ•ˆå†…å®¹
            const lowQualityPatterns = [
              /^test$/i,
              /^hello$/i,
              /^hi$/i,
              /^help$/i,
              /^é—®é¢˜$/,
              /^æ±‚åŠ©$/
            ];
            
            if (lowQualityPatterns.some(pattern => pattern.test(title))) {
              issues.push('æ ‡é¢˜è¿‡äºç®€å•ï¼Œè¯·æä¾›æ›´å…·ä½“çš„æè¿°');
            }
            
            if (issues.length > 0) {
              const feedbackMessage = `âš ï¸ **è®¨è®ºè´¨é‡å»ºè®®**\n\nä¸ºäº†è·å¾—æ›´å¥½çš„å¸®åŠ©å’Œè®¨è®ºæ•ˆæœï¼Œå»ºè®®æ‚¨æ”¹è¿›ä»¥ä¸‹æ–¹é¢ï¼š\n\n${issues.map(issue => `- ${issue}`).join('\n')}\n\n**æå‡è®¨è®ºè´¨é‡çš„å»ºè®®ï¼š**\n- ğŸ“ ä½¿ç”¨æè¿°æ€§çš„æ ‡é¢˜ï¼ŒåŒ…å«æ ¸å¿ƒå…³é”®è¯\n- ğŸ“‹ æä¾›è¯¦ç»†çš„èƒŒæ™¯ä¿¡æ¯å’Œå…·ä½“é—®é¢˜\n- ğŸ” æœç´¢ç°æœ‰è®¨è®ºï¼Œé¿å…é‡å¤\n- ğŸ“š æŸ¥é˜…é¡¹ç›®æ–‡æ¡£å’ŒFAQ\n\n**å¦‚ä½•ç¼–è¾‘è®¨è®ºï¼š**\nç‚¹å‡»æ ‡é¢˜æ—è¾¹çš„ âœï¸ å›¾æ ‡å¯ä»¥ç¼–è¾‘è®¨è®ºå†…å®¹ã€‚\n\næ„Ÿè°¢æ‚¨çš„ç†è§£å’Œé…åˆï¼`;
              
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: feedbackMessage
              });
            }

      - name: Auto-categorize Discussions
        uses: actions/github-script@v6
        if: github.event.action == 'created' && github.event.discussion
        with:
          script: |
            const discussion = context.payload.discussion;
            const title = discussion.title.toLowerCase();
            const body = (discussion.body || '').toLowerCase();
            const content = title + ' ' + body;
            
            // æ ¹æ®å†…å®¹è‡ªåŠ¨å»ºè®®åˆ†ç±»
            const categoryMap = {
              'Q&A': ['é—®é¢˜', 'å¦‚ä½•', 'how', 'help', 'æ±‚åŠ©', 'ä¸èƒ½', 'æ— æ³•', 'é”™è¯¯', 'error', 'é—®'],
              'Ideas': ['å»ºè®®', 'æƒ³æ³•', 'æ”¹è¿›', 'åŠŸèƒ½', 'feature', 'idea', 'å¸Œæœ›', 'å¯ä»¥', 'æ”¯æŒ'],
              'Show and tell': ['åˆ†äº«', 'å±•ç¤º', 'å®ç°', 'é…ç½®', 'æˆåŠŸ', 'share', 'show', 'æ•ˆæœ'],
              'General': ['è®¨è®º', 'äº¤æµ', 'discuss', 'chat', 'è¯é¢˜', 'ç¤¾åŒº']
            };
            
            let suggestedCategory = null;
            let maxMatches = 0;
            
            for (const [category, keywords] of Object.entries(categoryMap)) {
              const matches = keywords.filter(keyword => content.includes(keyword)).length;
              if (matches > maxMatches) {
                maxMatches = matches;
                suggestedCategory = category;
              }
            }
            
            if (suggestedCategory && maxMatches > 0) {
              const categoryMessage = `ğŸ·ï¸ **åˆ†ç±»å»ºè®®**\n\næ ¹æ®æ‚¨è®¨è®ºçš„å†…å®¹ï¼Œå»ºè®®å°†æ­¤è®¨è®ºå½’ç±»ä¸º **${suggestedCategory}**ã€‚\n\n**å„åˆ†ç±»è¯´æ˜ï¼š**\n- **Q&A** - æŠ€æœ¯é—®é¢˜ã€æ•…éšœæ’é™¤ã€ä½¿ç”¨å’¨è¯¢\n- **Ideas** - æ”¹è¿›å»ºè®®ã€æ–°åŠŸèƒ½æƒ³æ³•ã€æŠ€æœ¯è®¨è®º\n- **Show and tell** - æˆæœå±•ç¤ºã€é…ç½®åˆ†äº«ã€ç»éªŒæ¡ˆä¾‹\n- **General** - ä¸€èˆ¬æ€§è®¨è®ºã€ç¤¾åŒºè¯é¢˜ã€å¼€æ”¾äº¤æµ\n\nå¦‚éœ€è°ƒæ•´åˆ†ç±»ï¼Œè¯·ç¼–è¾‘è®¨è®ºè®¾ç½®ã€‚`;
              
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: categoryMessage
              });
            }

      - name: Encourage Best Practices
        uses: actions/github-script@v6
        if: github.event.action == 'created' && github.event.discussion
        with:
          script: |
            const discussion = context.payload.discussion;
            const body = discussion.body || '';
            
            const tips = [];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¯å¢ƒä¿¡æ¯
            if (!/æ“ä½œç³»ç»Ÿ|docker|version|ç¯å¢ƒ/.test(body.toLowerCase())) {
              tips.push('ğŸ’» **ç¯å¢ƒä¿¡æ¯** - æä¾›æ“ä½œç³»ç»Ÿã€Dockerç‰ˆæœ¬ç­‰ç¯å¢ƒä¿¡æ¯æœ‰åŠ©äºé—®é¢˜è¯Šæ–­');
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ—¥å¿—æˆ–é”™è¯¯ä¿¡æ¯
            if (!/æ—¥å¿—|log|é”™è¯¯|error|```/.test(body.toLowerCase())) {
              tips.push('ğŸ“‹ **æ—¥å¿—ä¿¡æ¯** - ç›¸å…³çš„é”™è¯¯æ—¥å¿—æˆ–é…ç½®ä¿¡æ¯èƒ½å¸®åŠ©æ›´å¿«å®šä½é—®é¢˜');
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆ
            if (!/å°è¯•|tried|è§£å†³|æœç´¢/.test(body.toLowerCase())) {
              tips.push('ğŸ” **å·²å°è¯•æ–¹æ¡ˆ** - è¯´æ˜å·²ç»å°è¯•è¿‡çš„è§£å†³æ–¹æ³•ï¼Œé¿å…é‡å¤å»ºè®®');
            }
            
            if (tips.length >= 2) {
              const tipsMessage = `ğŸ’¡ **è®¨è®ºä¼˜åŒ–å»ºè®®**\n\nä¸ºäº†è·å¾—æ›´ç²¾å‡†çš„å¸®åŠ©ï¼Œå»ºè®®è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š\n\n${tips.join('\n')}\n\n**å…¶ä»–å»ºè®®ï¼š**\n- ğŸ” æœç´¢ç°æœ‰è®¨è®ºå’Œissues\n- ğŸ“š æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£å’ŒFAQ\n- ğŸ–¼ï¸ é€‚å½“æ·»åŠ æˆªå›¾è¯´æ˜é—®é¢˜\n- âœ… é—®é¢˜è§£å†³åè¯·æ ‡è®°æœ€ä½³ç­”æ¡ˆ\n\næ‚¨å¯ä»¥ç¼–è¾‘åŸå§‹è®¨è®ºæ¥è¡¥å……è¿™äº›ä¿¡æ¯ã€‚`;
              
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: tipsMessage
              });
            }

      - name: Monitor Discussion Activity
        uses: actions/github-script@v6
        if: github.event.action == 'created' && github.event.discussion_comment
        with:
          script: |
            const comment = context.payload.comment;
            const discussion = context.payload.discussion;
            
            // æ„Ÿè°¢æ´»è·ƒå‚ä¸è€…
            const { data: comments } = await github.rest.discussions.listDiscussionComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              discussion_number: discussion.number
            });
            
            const userComments = comments.filter(c => c.user.login === comment.user.login);
            
            if (userComments.length === 5) {
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: `ğŸŒŸ æ„Ÿè°¢ @${comment.user.login} åœ¨æ­¤è®¨è®ºä¸­çš„ç§¯æå‚ä¸ï¼æ‚¨çš„è´¡çŒ®å¯¹ç¤¾åŒºå¾ˆæœ‰ä»·å€¼ã€‚`
              });
            }
            
            // æ£€æµ‹å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
            const solutionPatterns = [
              /è§£å†³äº†?|solved?|fixed?|works?/i,
              /æˆåŠŸäº†?|successful/i,
              /è°¢è°¢|thank/i,
              /å¯ä»¥äº†?|working/i
            ];
            
            if (solutionPatterns.some(pattern => pattern.test(comment.body))) {
              await github.rest.discussions.createDiscussionComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                discussion_number: discussion.number,
                body: `ğŸ‰ çœ‹èµ·æ¥é—®é¢˜å¯èƒ½å·²ç»è§£å†³ï¼å¦‚æœç¡®å®å¦‚æ­¤ï¼Œè¯·è€ƒè™‘ï¼š\n\n- âœ… æ ‡è®°æœ€ä½³ç­”æ¡ˆï¼ˆç‚¹å‡»æœ‰å¸®åŠ©å›å¤æ—è¾¹çš„å¤é€‰æ¡†ï¼‰\n- ğŸ“ ç®€è¦æ€»ç»“è§£å†³æ–¹æ¡ˆ\n- ğŸ¤ æ„Ÿè°¢æä¾›å¸®åŠ©çš„ç¤¾åŒºæˆå‘˜\n\nè¿™æ ·å¯ä»¥å¸®åŠ©å…¶ä»–é‡åˆ°ç±»ä¼¼é—®é¢˜çš„ç”¨æˆ·ï¼`
              });
            }