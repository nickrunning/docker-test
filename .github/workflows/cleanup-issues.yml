name: Close Invalid Issues

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼Œæ¸…ç†æ— æ•ˆissues
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  close-invalid-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Close stale issues with needs-more-info label
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'needs-more-info',
              sort: 'updated',
              direction: 'asc'
            });
            
            const now = new Date();
            const staleThreshold = 7 * 24 * 60 * 60 * 1000; // 7å¤©
            
            for (const issue of issues) {
              const updatedAt = new Date(issue.updated_at);
              const daysSinceUpdate = Math.floor((now - updatedAt) / (24 * 60 * 60 * 1000));
              
              if (now - updatedAt > staleThreshold) {
                console.log(`Closing stale issue #${issue.number} (${daysSinceUpdate} days old)`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ğŸ¤– **è‡ªåŠ¨å…³é—­é€šçŸ¥**\n\nè¿™ä¸ªissueå·²ç»æ ‡è®°ä¸ºéœ€è¦æ›´å¤šä¿¡æ¯è¶…è¿‡7å¤©ï¼Œä¸”æ²¡æœ‰æ”¶åˆ°å›å¤ã€‚ä¸ºäº†ä¿æŒissueåˆ—è¡¨çš„æ•´æ´ï¼Œç°åœ¨è‡ªåŠ¨å…³é—­æ­¤issueã€‚\n\nå¦‚æœæ‚¨ä»ç„¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š\n1. æä¾›æˆ‘ä»¬ä¹‹å‰è¯·æ±‚çš„ä¿¡æ¯\n2. é‡æ–°å¼€å¯æ­¤issueæˆ–åˆ›å»ºæ–°çš„issue\n\næˆ‘ä»¬éšæ—¶æ¬¢è¿æ‚¨æä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'not_planned'
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['auto-closed']
                });
              }
            }

      - name: Add warning to old issues without labels
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });
            
            const now = new Date();
            const oldThreshold = 3 * 24 * 60 * 60 * 1000; // 3å¤©
            
            for (const issue of issues) {
              const createdAt = new Date(issue.created_at);
              const isOld = now - createdAt > oldThreshold;
              const hasTriageLabel = issue.labels.some(label => label.name === 'triage');
              const hasNeedsInfoLabel = issue.labels.some(label => label.name === 'needs-more-info');
              
              if (isOld && hasTriageLabel && !hasNeedsInfoLabel) {
                console.log(`Adding reminder to issue #${issue.number}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `â° **æé†’**\n\nè¿™ä¸ªissueå·²ç»å¼€æ”¾3å¤©äº†ï¼Œä½†è¿˜æ²¡æœ‰è¢«æ ‡è®°æˆ–åˆ†ç±»ã€‚\n\n**ç»´æŠ¤è€…è¯·æ³¨æ„ï¼š**\n- è¯·å®¡æŸ¥æ­¤issueå¹¶æ·»åŠ é€‚å½“çš„æ ‡ç­¾\n- å¦‚æœéœ€è¦æ›´å¤šä¿¡æ¯ï¼Œè¯·æ·»åŠ  \`needs-more-info\` æ ‡ç­¾\n- å¦‚æœæ˜¯æœ‰æ•ˆçš„bugæˆ–åŠŸèƒ½è¯·æ±‚ï¼Œè¯·ç§»é™¤ \`triage\` æ ‡ç­¾å¹¶æ·»åŠ é€‚å½“çš„ä¼˜å…ˆçº§æ ‡ç­¾\n\n**æäº¤è€…è¯·æ³¨æ„ï¼š**\n- å¦‚æœæ‚¨æœ‰æ›´å¤šä¿¡æ¯å¯ä»¥è¡¥å……ï¼Œè¯·éšæ—¶æ·»åŠ \n- ç¡®ä¿æ‚¨å·²ç»æä¾›äº†è¶³å¤Ÿçš„è¯¦ç»†ä¿¡æ¯æ¥é‡ç°é—®é¢˜æˆ–ç†è§£åŠŸèƒ½éœ€æ±‚`
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });
              }
            }